<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>آلة حاسبة عصرية - اليوميات</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* إعدادات عامة */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html, body {
      width: 100%;
      min-height: 100vh;
    }
    /* سيتم تعديل اتجاه الصفحة عبر خاصية dir في html */
    body {
      font-family: 'Cairo', sans-serif;
      background: #1d1f21;
      /* ملاحظة: سيتم تعديل اتجاه body تلقائيًا عند تغيير dir في html */
    }
    /* إذا كان body يحمل dir="ltr" نطبق هذا */
    body[dir="ltr"] {
      direction: ltr !important;
    }
    .app-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
    }
    /* ========= آلة حاسبة محترفة (ملء الشاشة) ========= */
    .calculator-container {
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #141e30, #243b55);
      width: 100vw;
      height: 100vh;
      padding: 0;
    }
    .calculator {
      background: #1c1f26;
      border-radius: 0;
      box-shadow: none;
      width: 100%;
      height: 100vh;
      padding: 20px;
      direction: ltr;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .calculator::-webkit-scrollbar {
      display: none;
    }
    .calculator {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .display {
      background: #2c2f36;
      color: #f1f2f6;
      font-size: 2.5rem;
      text-align: right;
      padding: 20px;
      border: none;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.3);
    }
    .buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      flex-grow: 1;
    }
    .buttons button {
      border: none;
      border-radius: 10px;
      font-size: 1.5rem;
      background: #3b3e46;
      color: #ffffff;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      padding: 20px;
    }
    .buttons button:hover {
      background: #4e5259;
    }
    .buttons button:active {
      transform: scale(0.95);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn.equals {
      grid-column: span 1;
      background: #1dd1a1;
    }
    .btn.equals:hover {
      background: #10ac84;
    }
    /* ========= اليوميات ========= */
    .diary-container {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      padding: 20px;
      background: #2e3033;
      color: #fff;
      transition: background 0.3s, color 0.3s;
      flex-direction: column;
      overflow-y: auto;
    }
    .diary-container,
    .diary-container::-webkit-scrollbar {
      display: none;
    }
    .diary-container {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* زر تبديل وضع اليوميات */
    #diaryModeToggle {
      display: inline-block;
      margin: 0 10px 20px 0;
      font-size: 1.8rem;
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
    }
    /* أيقونة اختيار اللغة في الزاوية اليمنى */
    #langIcon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.8rem;
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
      z-index: 1100;
    }
    /* قائمة اللغة المنسدلة بتصميم أنيق */
    .lang-dropdown {
      display: none;
      position: absolute;
      top: 45px;
      right: 10px;
      background: #2e3033;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      overflow: hidden;
      z-index: 1100;
    }
    .lang-dropdown .lang-item {
      padding: 10px 15px;
      cursor: pointer;
      text-align: right;
      transition: background 0.3s;
    }
    .lang-dropdown .lang-item:hover {
      background: #3b3e46;
    }
    #diaryInputForm .back-to-calculator {
      display: block;
      margin-bottom: 10px;
      background: none;
      border: none;
      font-size: 1.8rem;
      color: inherit;
      cursor: pointer;
      text-align: left;
      width: 100%;
    }
    #diaryInputForm {
      margin-top: 20px;
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
    }
    #diaryInputForm h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #fff !important;
    }
    .diary-dark-mode #diaryInputForm h2 {
      color: #fff !important;
    }
    #diaryInputForm input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      transition: background 0.3s, color 0.3s;
    }
    #diaryInputForm textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      transition: background 0.3s, color 0.3s;
      height: 300px;
      resize: vertical;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    #diaryInputForm textarea::-webkit-scrollbar {
      display: none;
    }
    #diaryTitle::placeholder,
    #diaryText::placeholder {
      color: #ccc;
    }
    #diaryInputForm .diary-buttons {
      margin-top: auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    #diaryInputForm .diary-buttons button {
      flex: 1;
      margin: 5px;
      padding: 12px 10px;
      font-size: 1rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s, transform 0.2s;
      color: #fff;
      background-color: #008cba;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    #diaryInputForm .diary-buttons button:hover {
      background-color: #0073a5;
      transform: scale(1.05);
    }
    .diary-grid-view {
      display: none;
      flex: 1;
      flex-direction: column;
      padding: 20px;
      width: 100%;
      overflow-y: auto;
      transition: background 0.3s, color 0.3s;
      position: relative;
    }
    .back-to-input {
      position: absolute;
      top: 5px;
      left: 20px;
      font-size: 1.8rem;
      font-weight: bold;
      cursor: pointer;
      padding: 0;
      margin: 0;
      background: none;
      border: none;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      color: white;
    }
    .search-bar {
      display: flex;
      align-items: center;
      margin: 1cm 0 20px 0;
      gap: 10px;
    }
    .search-bar input {
      flex: 1;
      padding: 12px;
      font-size: 1.1rem;
      border: 2px solid #ccc;
      border-radius: 8px;
      outline: none;
      transition: border-color 0.3s;
    }
    .search-bar input:focus {
      border-color: #008cba;
    }
    .diary-card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .diary-card:hover {
      transform: translateY(-3px);
    }
    .diary-card .diary-datetime {
      font-size: 0.9rem;
      color: #777;
      margin-bottom: 10px;
    }
    .diary-card hr {
      border: 0;
      height: 1px;
      background: #ddd;
      margin-bottom: 10px;
    }
    .diary-card .diary-title {
      font-size: 1.5rem;
      font-weight: bold;
      color: #333;
    }
    .diary-dark-mode .diary-card .diary-title {
      color: #0f0 !important;
    }
    /* ========= النوافذ المنبثقة ========= */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
      position: relative;
      color: #000;
      text-align: center;
      max-height: 80vh;
      overflow-y: auto;
      transition: background 0.3s, color 0.3s;
    }
    .modal .close {
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    #diaryModal .modal-content > .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #diaryModal .modal-content h2,
    #diaryModal .modal-content p {
      word-wrap: break-word;
    }
    .modal .small-delete-btn {
      width: auto !important;
      padding: 2px 4px !important;
      margin: 0 !important;
      font-size: 0.8rem !important;
      line-height: 1 !important;
      background: none;
      border: none;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .modal .small-delete-btn img {
      width: 20px;
      height: 20px;
      filter: invert(0);
      transition: filter 0.3s;
    }
    .modal .small-delete-btn:hover {
      transform: scale(1.1);
    }
    .modal input, 
    .modal button {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .modal button {
      background: #4caf50;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    /* ========= قسم إدارة الحساب ========= */
    .account-info {
      max-width: 400px;
      width: 90%;
      text-align: center;
      overflow: hidden;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .account-info .account-profile {
      margin-bottom: 10px;
      cursor: pointer;
    }
    .account-info .account-profile img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto;
      border: 2px solid #555;
    }
    #imageOptions {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      animation: fadeIn 0.5s ease-out;
    }
    #imageOptions button {
      margin: 10px 0;
      padding: 10px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      background: linear-gradient(45deg, #ff9800, #f44336);
      color: #fff;
      cursor: pointer;
      transition: transform 0.3s, background 0.3s;
      width: 80%;
    }
    #imageOptions button:hover {
      transform: scale(1.05);
      background: linear-gradient(45deg, #f44336, #ff9800);
    }
    .account-info .diary-count {
      margin-bottom: 10px;
      font-size: 1.2rem;
    }
    .account-info .account-details {
      margin-bottom: 10px;
    }
    .account-info button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #8e44ad;
      color: #fff;
      transition: background 0.2s;
    }
    .account-info button:hover {
      background: #7d3c98;
    }
    #saveAccountInfoBtn { background: #8e44ad; }
    #accountImageInput { display: none; }
    .password-fields { display: none; }
    #passwordOptionButtons {
      display: flex;
      justify-content: space-around;
      margin-bottom: 10px;
    }
    #passwordOptionButtons button {
      flex: 1;
      margin: 0 5px;
      padding: 10px;
      border-radius: 5px;
      background: #3a3d40;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    #passwordOptionButtons button:hover {
      background: #5563de;
    }
    #changePasswordFields input { margin-bottom: 0.5cm; }
    #deleteConfirmModal .modal-content,
    #logoutConfirmModal .modal-content {
      padding: 30px;
      border-radius: 15px;
      max-width: 400px;
      text-align: center;
    }
    #deleteConfirmModal p,
    #logoutConfirmModal p {
      margin: 20px 0;
      font-size: 1.1rem;
    }
    #deleteConfirmModal button,
    #logoutConfirmModal button {
      margin: 10px 5px;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    #deleteConfirmModal button:first-of-type,
    #logoutConfirmModal button:first-of-type {
      background-color: #f44336;
      color: #fff;
    }
    #deleteConfirmModal button:last-of-type,
    #logoutConfirmModal button:last-of-type {
      background-color: #4caf50;
      color: #fff;
    }
    #messageBox {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 1.2rem;
      display: none;
      z-index: 3000;
      text-align: center;
    }
    .diary-dark-mode .app-container,
    .diary-dark-mode .diary-container {
      background: #000 !important;
      color: #0f0 !important;
    }
    .diary-dark-mode input,
    .diary-dark-mode textarea {
      background: #111;
      color: #0f0;
      border: 1px solid #0f0;
    }
    .diary-dark-mode .diary-buttons button,
    .diary-dark-mode .diary-card,
    .diary-dark-mode .back-to-input {
      background: #111 !important;
      color: #0f0 !important;
      border: 1px solid #0f0 !important;
    }
    .diary-dark-mode .diary-card .diary-datetime { color: #0f0 !important; }
    .diary-dark-mode .diary-grid-view {
      background: transparent !important;
      color: inherit !important;
      border: none !important;
    }
    .modal.diary-dark-mode .modal-content {
      background: #111 !important;
      color: #0f0 !important;
      border: 1px solid #0f0 !important;
    }
    .diary-dark-mode .back-to-input {
      background: none !important;
      border: none !important;
      box-shadow: none !important;
    }
    .diary-dark-mode .small-delete-btn img { filter: invert(1); }
    .diary-dark-mode .account-info button {
      background: #004d00 !important;
      color: #0f0 !important;
    }
    #accountActionsModal .modal-content h2 { margin-bottom: 0.5cm; }
    #deletePasswordModal .modal-content p { margin-bottom: 0.5cm; }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    .diary-grid-view::-webkit-scrollbar,
    .modal-content::-webkit-scrollbar,
    .account-info::-webkit-scrollbar {
      display: none;
    }
    @media (max-width: 600px) {
      .display { font-size: 1.5rem; padding: 15px; }
      .buttons button { font-size: 1.2rem; padding: 15px; }
      #diaryModeToggle, #langIcon { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <!-- آلة حاسبة محترفة -->
  <div class="app-container calculator-container">
    <div class="calculator">
      <input type="text" id="display" class="display" readonly>
      <div class="buttons">
        <!-- وظائف الذاكرة -->
        <button onclick="memoryClear()">MC</button>
        <button onclick="memoryRecall()">MR</button>
        <button onclick="memoryAdd()">M+</button>
        <button onclick="memorySubtract()">M-</button>
        <!-- الصف الثاني -->
        <button onclick="clearInput()">C</button>
        <button onclick="backspace()">⌫</button>
        <button onclick="applySqrt()">√</button>
        <button onclick="appendOperator('÷')">÷</button>
        <!-- الصف الثالث -->
        <button onclick="appendDigit('7')">7</button>
        <button onclick="appendDigit('8')">8</button>
        <button onclick="appendDigit('9')">9</button>
        <button onclick="appendOperator('×')">×</button>
        <!-- الصف الرابع -->
        <button onclick="appendDigit('4')">4</button>
        <button onclick="appendDigit('5')">5</button>
        <button onclick="appendDigit('6')">6</button>
        <button onclick="appendOperator('-')">−</button>
        <!-- الصف الخامس -->
        <button onclick="appendDigit('1')">1</button>
        <button onclick="appendDigit('2')">2</button>
        <button onclick="appendDigit('3')">3</button>
        <button onclick="appendOperator('+')">+</button>
        <!-- الصف السادس -->
        <button onclick="toggleSign()">±</button>
        <button onclick="appendDigit('0')">0</button>
        <button onclick="appendDigit('.')">.</button>
        <button onclick="calculateResult()" class="btn equals">=</button>
      </div>
    </div>
  </div>
  
  <!-- اليوميات -->
  <div class="app-container diary-container">
    <!-- زر تبديل وضع اليوميات -->
    <button id="diaryModeToggle" onclick="toggleDiaryMode()">🌙</button>
    <!-- أيقونة اختيار اللغة -->
    <button id="langIcon" onclick="toggleLangDropdown()">🌐</button>
    <!-- القائمة المنسدلة لتحديد اللغة -->
    <div id="langDropdown" class="lang-dropdown">
      <div class="lang-item" onclick="setLanguage('ar')">العربية</div>
      <div class="lang-item" onclick="setLanguage('en')">English</div>
    </div>
    <div id="diaryInputForm">
      <button class="back-to-calculator" onclick="goBack()">←</button>
      <h2 id="diaryHeader">اليوميات</h2>
      <input type="text" id="diaryTitle" placeholder="عنوان اليومية">
      <textarea id="diaryText" placeholder="اكتب يومياتك هنا..."></textarea>
      <div class="diary-buttons">
        <button class="save" onclick="saveDiary();">حفظ</button>
        <button class="view" onclick="showDiaryGridView()">مشاهدة اليوميات</button>
        <button class="account" onclick="openAccountPanel()">حساب</button>
      </div>
    </div>
    <div id="diaryGridView" class="diary-grid-view">
      <button onclick="backToDiaryInput()" class="back-to-input">←</button>
      <div class="search-bar">
        <input type="text" id="diarySearchInput" placeholder="ابحث في اليوميات" oninput="searchDiary()">
      </div>
      <div id="diaryGrid" class="diary-grid">
        <!-- بطاقات اليوميات تظهر هنا -->
      </div>
    </div>
  </div>
  
  <!-- النوافذ المنبثقة (Modals) -->
  <div id="diaryModal" class="modal">
    <div class="modal-content">
      <div class="header">
        <button onclick="deleteDiaryEntry()" class="small-delete-btn">
          <img src="https://cdn-icons-png.flaticon.com/512/1214/1214428.png" alt="حذف">
        </button>
        <span class="close" onclick="closeDiaryModal()">&times;</span>
      </div>
      <h2 id="modalTitle" style="margin-top:10px;"></h2>
      <p id="modalText"></p>
    </div>
  </div>
  <div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeDeleteConfirmModal()">&times;</span>
      <p id="deleteConfirmText">هل أنت متأكد من حذف هذه اليومية؟</p>
      <button onclick="closeDeleteConfirmModal()">
        <span id="cancelDeleteBtn">إلغاء</span>
      </button>
      <button onclick="promptDeletePassword()">
        <span id="confirmDeleteBtn">تأكيد</span>
      </button>
    </div>
  </div>
  <div id="deletePasswordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeDeletePasswordModal()">&times;</span>
      <h2 id="deletePasswordHeader">تأكيد الحذف</h2>
      <p id="deletePasswordInstruction" style="margin-bottom: 0.5cm;">أدخل كلمة سر الحساب لتأكيد الحذف:</p>
      <input type="password" id="deletePasswordInput" placeholder="كلمة السر" oninput="this.value=this.value.replace(/[^\d]/g,'')">
      <button onclick="confirmDeleteWithPassword()" id="confirmDeletePasswordBtn">تأكيد</button>
    </div>
  </div>
  <div id="accountActionsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAccountActionsModal()">&times;</span>
      <h2 id="accountActionsHeader">إدارة الحساب</h2>
      <button onclick="openAccountCreationModal()">
        <span id="createAccountBtn">إنشاء حساب</span>
      </button>
      <button onclick="openLoginModal()">
        <span id="loginBtnModal">تسجيل الدخول</span>
      </button>
    </div>
  </div>
  <div id="accountCreationModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeAccountCreationModal()">&times;</span>
      <h2 id="accountCreationHeader">إنشاء الحساب</h2>
      <p id="accountCreationInstruction">يرجى إدخال بريدك الإلكتروني وكلمة المرور (الحد الأدنى 8 أرقام):</p>
      <input type="email" id="accountEmail" placeholder="البريد الإلكتروني (بأحرف صغيرة)">
      <input type="password" id="accountPassword" placeholder="كلمة المرور" oninput="this.value=this.value.replace(/[^\d]/g,'')">
      <button onclick="createAccount();" id="createAccountBtnModal">
        <span id="createAccountBtnText">إنشاء الحساب</span>
      </button>
    </div>
  </div>
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeLoginModal()">&times;</span>
      <h2 id="loginHeader">تسجيل الدخول</h2>
      <p id="loginInstruction" style="margin-bottom: 0.5cm;">يرجى إدخال بريدك الإلكتروني وكلمة المرور:</p>
      <input type="email" id="loginEmail" placeholder="البريد الإلكتروني">
      <input type="password" id="loginPassword" placeholder="كلمة المرور" oninput="this.value=this.value.replace(/[^\d]/g,'')">
      <button onclick="login();" id="loginBtn">
        <span id="loginBtnText">تسجيل الدخول</span>
      </button>
      <button onclick="showMessage(translations[currentLang].optionNotWorking, 2000)" id="forgotPasswordBtn" style="background: #ff5722;">
        <span id="forgotPasswordBtnText">نسيت كلمة السر؟</span>
      </button>
    </div>
  </div>
  <div id="accountInfoModal" class="modal">
    <div class="modal-content account-info">
      <span class="close" onclick="closeAccountInfoModal()">&times;</span>
      <div class="account-profile">
        <img id="accountProfileImage" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="صورة الحساب" onclick="toggleImageOptions()">
      </div>
      <div id="imageOptions">
        <button onclick="triggerChangeImage()" id="changeImageBtn">تغيير الصورة</button>
        <button onclick="deleteProfileImage()" id="deleteImageBtn">حذف الصورة</button>
      </div>
      <div class="diary-count">
        <p id="diaryCountText">عدد اليوميات: 0</p>
      </div>
      <div class="account-details">
        <input type="text" id="accountNameInput" placeholder="">
      </div>
      <button onclick="openChangePasswordModal()" id="changePasswordBtn">تغيير كلمة السر</button>
      <button onclick="saveAccountInfoChanges();" id="saveAccountInfoBtn">حفظ التغييرات</button>
      <button onclick="openLogoutConfirmModal()">تسجيل الخروج</button>
      <input type="file" id="accountImageInput" accept="image/*" onchange="changeProfileImage(event)">
    </div>
  </div>
  <div id="changePasswordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeChangePasswordModal()">&times;</span>
      <h2 id="changePasswordHeader" style="margin-bottom: 0.5cm;">تغيير كلمة السر</h2>
      <div id="passwordOptionButtons">
        <button onclick="selectPasswordOption('account')" id="accountPasswordOptionBtn">تغيير كلمة سر الحساب</button>
        <button onclick="selectPasswordOption('calc')" id="calcPasswordOptionBtn">تغيير كلمة سر الآلة حاسبة</button>
      </div>
      <div id="changePasswordFields" class="password-fields">
        <input type="password" id="oldPasswordInput" placeholder="أدخل كلمة السر الحالية" oninput="this.value=this.value.replace(/[^\d]/g,'')">
        <input type="password" id="newPasswordInput" placeholder="أدخل كلمة السر الجديدة (8 أرقام على الأقل)" oninput="this.value=this.value.replace(/[^\d]/g,'')">
        <input type="password" id="confirmNewPasswordInput" placeholder="أكد كلمة السر الجديدة" oninput="this.value=this.value.replace(/[^\d]/g,'')">
        <button onclick="submitChangePassword();" id="confirmChangePasswordBtn">تأكيد التغيير</button>
      </div>
    </div>
  </div>
  <div id="forgotPasswordModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeForgotPasswordModal()">&times;</span>
      <h2 id="forgotPasswordHeader">نسيت كلمة السر</h2>
      <p id="forgotPasswordInstruction">يرجى إدخال بريدك الإلكتروني لاستلام كود إعادة التعيين:</p>
      <input type="email" id="forgotEmail" placeholder="البريد الإلكتروني">
      <button onclick="sendForgotPasswordCode();">إرسال الكود</button>
    </div>
  </div>
  <div id="logoutConfirmModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeLogoutConfirmModal()">&times;</span>
      <p id="logoutConfirmText">هل أنت متأكد من تسجيل الخروج؟</p>
      <button onclick="confirmLogout();">
        <span id="logoutYesBtn">نعم</span>
      </button>
      <button onclick="closeLogoutConfirmModal()">
        <span id="logoutCancelBtn">إلغاء</span>
      </button>
    </div>
  </div>
  <div id="messageBox"></div>
  
  <script>
    /* كائن الترجمات لكافة النصوص */
    var translations = {
      ar: {
        diaryHeader: "اليوميات",
        diaryTitlePlaceholder: "عنوان اليومية",
        diaryTextPlaceholder: "اكتب يومياتك هنا...",
        saveBtn: "حفظ",
        viewBtn: "مشاهدة اليوميات",
        accountBtn: "حساب",
        diarySearchPlaceholder: "ابحث في اليوميات",
        calcError: "خطأ",
        deleteConfirmText: "هل أنت متأكد من حذف هذه اليومية؟",
        cancelBtn: "إلغاء",
        yesBtn: "نعم",
        deletePasswordHeader: "تأكيد الحذف",
        deletePasswordInstruction: "أدخل كلمة سر الحساب لتأكيد الحذف:",
        deletePasswordPlaceholder: "كلمة السر",
        accountActionsHeader: "إدارة الحساب",
        createAccountBtn: "إنشاء حساب",
        loginBtn: "تسجيل الدخول",
        accountCreationHeader: "إنشاء الحساب",
        accountCreationInstruction: "يرجى إدخال بريدك الإلكتروني وكلمة المرور (الحد الأدنى 8 أرقام):",
        accountEmailPlaceholder: "البريد الإلكتروني (بأحرف صغيرة)",
        accountPasswordPlaceholder: "كلمة المرور",
        loginHeader: "تسجيل الدخول",
        loginInstruction: "يرجى إدخال بريدك الإلكتروني وكلمة المرور:",
        loginEmailPlaceholder: "البريد الإلكتروني",
        loginPasswordPlaceholder: "كلمة المرور",
        forgotPasswordBtn: "نسيت كلمة السر؟",
        accountInfoAccountCount: "عدد اليوميات: ",
        changePasswordHeader: "تغيير كلمة السر",
        oldPasswordPlaceholderAccount: "أدخل كلمة السر الحالية (حساب)",
        oldPasswordPlaceholderCalc: "أدخل كلمة السر الحالية (آلة حاسبة)",
        newPasswordPlaceholder: "أدخل كلمة السر الجديدة (8 أرقام على الأقل)",
        confirmNewPasswordPlaceholder: "أكد كلمة السر الجديدة",
        changePasswordConfirmBtn: "تأكيد التغيير",
        forgotPasswordHeader: "نسيت كلمة السر",
        forgotPasswordInstruction: "يرجى إدخال بريدك الإلكتروني لاستلام كود إعادة التعيين:",
        logoutConfirmText: "هل أنت متأكد من تسجيل الخروج؟",
        logoutYesBtn: "نعم",
        logoutCancelBtn: "إلغاء",
        accountLogoutBtn: "تسجيل الخروج",
        accountCreatedMsg: "تم إنشاء الحساب",
        loginSuccessMsg: "تم تسجيل الدخول",
        loginFailedMsg: "بيانات الدخول غير صحيحة",
        changesSavedMsg: "تم حفظ التغييرات",
        passwordChangedMsg: "تم تغيير كلمة السر بنجاح",
        noAccountMsg: "لا يوجد حساب مسجل",
        imageChangedMsg: "تم تغيير الصورة مؤقتاً",
        imageDeletedMsg: "تم حذف الصورة مؤقتاً",
        deletionSuccessMsg: "تم حذف اليومية",
        saveChangesBtn: "حفظ التغييرات",
        accountNamePlaceholder: "اسم الحساب",
        accountPasswordOption: "تغيير كلمة سر الحساب",
        calcPasswordOption: "تغيير كلمة سر الآلة حاسبة",
        changeImageBtn: "تغيير الصورة",
        optionNotWorking: "هذا الخيار لا يعمل حالياً",
        changePasswordBtn: "تغيير كلمة السر",
        confirmChangePasswordBtn: "تأكيد التغيير",
        deleteImageBtn: "حذف الصورة",
        dateTimeSeparator: " | ",
        diarySavedMsg: "تم الحفظ"
      },
      en: {
        diaryHeader: "Diary",
        diaryTitlePlaceholder: "Diary Title",
        diaryTextPlaceholder: "Write your diary entry here...",
        saveBtn: "Save",
        viewBtn: "View Diaries",
        accountBtn: "Account",
        diarySearchPlaceholder: "Search diaries",
        calcError: "Error",
        deleteConfirmText: "Are you sure you want to delete this diary entry?",
        cancelBtn: "Cancel",
        yesBtn: "Yes",
        deletePasswordHeader: "Delete Confirmation",
        deletePasswordInstruction: "Enter your account password to confirm deletion:",
        deletePasswordPlaceholder: "Password",
        accountActionsHeader: "Account Management",
        createAccountBtn: "Create Account",
        loginBtn: "Login",
        accountCreationHeader: "Create Account",
        accountCreationInstruction: "Please enter your email and password (minimum 8 digits):",
        accountEmailPlaceholder: "Email (lowercase)",
        accountPasswordPlaceholder: "Password",
        loginHeader: "Login",
        loginInstruction: "Please enter your email and password:",
        loginEmailPlaceholder: "Email",
        loginPasswordPlaceholder: "Password",
        forgotPasswordBtn: "Forgot Password?",
        accountInfoAccountCount: "Diary Count: ",
        changePasswordHeader: "Change Password",
        oldPasswordPlaceholderAccount: "Enter current password (Account)",
        oldPasswordPlaceholderCalc: "Enter current password (Calculator)",
        newPasswordPlaceholder: "Enter new password (min 8 digits)",
        confirmNewPasswordPlaceholder: "Confirm new password",
        changePasswordConfirmBtn: "Confirm Change",
        forgotPasswordHeader: "Forgot Password",
        forgotPasswordInstruction: "Please enter your email to receive a reset code:",
        logoutConfirmText: "Are you sure you want to log out?",
        logoutYesBtn: "Yes",
        logoutCancelBtn: "Cancel",
        accountLogoutBtn: "Logout",
        accountCreatedMsg: "Account created",
        loginSuccessMsg: "Logged in successfully",
        loginFailedMsg: "Login failed",
        changesSavedMsg: "Changes saved",
        passwordChangedMsg: "Password changed successfully",
        noAccountMsg: "No account found",
        imageChangedMsg: "Image temporarily changed",
        imageDeletedMsg: "Image temporarily deleted",
        deletionSuccessMsg: "Diary entry deleted",
        saveChangesBtn: "Save Changes",
        accountNamePlaceholder: "Account Name",
        accountPasswordOption: "Change Account Password",
        calcPasswordOption: "Change Calculator Password",
        changeImageBtn: "Change Image",
        optionNotWorking: "This option does not work",
        changePasswordBtn: "Change Password",
        confirmChangePasswordBtn: "Confirm Change",
        deleteImageBtn: "Delete Image",
        dateTimeSeparator: " | ",
        diarySavedMsg: "Diary saved"
      }
    };

    /* دوال التشفير لدعم الأحرف العربية */
    function encrypt(text) {
      return btoa(encodeURIComponent(text));
    }
    function decrypt(text) {
      return decodeURIComponent(atob(text));
    }

    /* دالة تطبيق الترجمات على كافة النصوص الثابتة */
    function applyTranslations() {
      // نموذج اليوميات
      document.getElementById('diaryHeader').innerText = translations[currentLang].diaryHeader;
      document.getElementById('diaryTitle').placeholder = translations[currentLang].diaryTitlePlaceholder;
      document.getElementById('diaryText').placeholder = translations[currentLang].diaryTextPlaceholder;
      document.querySelector('#diaryInputForm .diary-buttons .save').innerText = translations[currentLang].saveBtn;
      document.querySelector('#diaryInputForm .diary-buttons .view').innerText = translations[currentLang].viewBtn;
      document.querySelector('#diaryInputForm .diary-buttons .account').innerText = translations[currentLang].accountBtn;
      document.getElementById('diarySearchInput').placeholder = translations[currentLang].diarySearchPlaceholder;
      // نوافذ التأكيد والحذف
      document.getElementById('deleteConfirmText').innerText = translations[currentLang].deleteConfirmText;
      document.querySelector('#deleteConfirmModal button:nth-of-type(1) span').innerText = translations[currentLang].cancelBtn;
      document.querySelector('#deleteConfirmModal button:nth-of-type(2) span').innerText = translations[currentLang].yesBtn;
      document.getElementById('deletePasswordHeader').innerText = translations[currentLang].deletePasswordHeader;
      document.getElementById('deletePasswordInstruction').innerText = translations[currentLang].deletePasswordInstruction;
      document.getElementById('deletePasswordInput').placeholder = translations[currentLang].deletePasswordPlaceholder;
      document.getElementById('confirmDeletePasswordBtn').innerText = translations[currentLang].confirmChangePasswordBtn;
      // نافذة إدارة الحساب
      document.getElementById('accountActionsHeader').innerText = translations[currentLang].accountActionsHeader;
      var accountActionsButtons = document.querySelectorAll('#accountActionsModal button');
      accountActionsButtons[0].querySelector('span').innerText = translations[currentLang].createAccountBtn;
      accountActionsButtons[1].querySelector('span').innerText = translations[currentLang].loginBtn;
      // نافذة إنشاء الحساب
      document.getElementById('accountCreationHeader').innerText = translations[currentLang].accountCreationHeader;
      document.getElementById('accountCreationInstruction').innerText = translations[currentLang].accountCreationInstruction;
      document.getElementById('accountEmail').placeholder = translations[currentLang].accountEmailPlaceholder;
      document.getElementById('accountPassword').placeholder = translations[currentLang].accountPasswordPlaceholder;
      document.getElementById('createAccountBtnModal').querySelector('span').innerText = translations[currentLang].createAccountBtn;
      // نافذة تسجيل الدخول
      document.getElementById('loginHeader').innerText = translations[currentLang].loginHeader;
      document.getElementById('loginInstruction').innerText = translations[currentLang].loginInstruction;
      document.getElementById('loginEmail').placeholder = translations[currentLang].loginEmailPlaceholder;
      document.getElementById('loginPassword').placeholder = translations[currentLang].loginPasswordPlaceholder;
      document.getElementById('loginBtn').querySelector('span').innerText = translations[currentLang].loginBtn;
      document.getElementById('forgotPasswordBtn').querySelector('span').innerText = translations[currentLang].forgotPasswordBtn;
      // نافذة تغيير كلمة السر
      document.getElementById('changePasswordHeader').innerText = translations[currentLang].changePasswordHeader;
      document.getElementById('oldPasswordInput').placeholder = translations[currentLang].oldPasswordPlaceholderAccount;
      document.getElementById('newPasswordInput').placeholder = translations[currentLang].newPasswordPlaceholder;
      document.getElementById('confirmNewPasswordInput').placeholder = translations[currentLang].confirmNewPasswordPlaceholder;
      document.getElementById('confirmChangePasswordBtn').innerText = translations[currentLang].confirmChangePasswordBtn;
      // نافذة نسيت كلمة السر
      document.getElementById('forgotPasswordHeader').innerText = translations[currentLang].forgotPasswordHeader;
      document.getElementById('forgotPasswordInstruction').innerText = translations[currentLang].forgotPasswordInstruction;
      // نافذة تأكيد تسجيل الخروج
      document.getElementById('logoutConfirmText').innerText = translations[currentLang].logoutConfirmText;
      document.querySelector('#logoutConfirmModal button:nth-of-type(1) span').innerText = translations[currentLang].logoutYesBtn;
      document.querySelector('#logoutConfirmModal button:nth-of-type(2) span').innerText = translations[currentLang].logoutCancelBtn;
      // زر تسجيل الخروج داخل نافذة معلومات الحساب
      var accountInfoButtons = document.querySelectorAll('#accountInfoModal button');
      accountInfoButtons.forEach(function(btn) {
        if(btn.innerText.trim() === "تسجيل الخروج" || btn.innerText.trim() === "Logout") {
          btn.innerText = translations[currentLang].accountLogoutBtn;
        }
      });
      // تحديث حقل اسم الحساب
      document.getElementById('accountNameInput').placeholder = translations[currentLang].accountNamePlaceholder;
      // تحديث زر حفظ التغييرات
      document.getElementById('saveAccountInfoBtn').innerText = translations[currentLang].saveChangesBtn;
      // تحديث عدد اليوميات
      updateDiaryCount();
      // تحديث خيارات تغيير كلمة السر
      document.getElementById('accountPasswordOptionBtn').innerText = translations[currentLang].accountPasswordOption;
      document.getElementById('calcPasswordOptionBtn').innerText = translations[currentLang].calcPasswordOption;
      // تحديث زر تغيير الصورة
      document.getElementById('changeImageBtn').innerText = translations[currentLang].changeImageBtn;
      // تحديث زر تغيير كلمة السر في نافذة معلومات الحساب
      document.getElementById('changePasswordBtn').innerText = translations[currentLang].changePasswordBtn;
      // تحديث زر حذف الصورة في قائمة الصورة
      document.getElementById('deleteImageBtn').innerText = translations[currentLang].deleteImageBtn;
      
      // ضبط اتجاه الكتابة في مدخلات اليوميات حسب اللغة
      if (currentLang === 'ar') {
        document.getElementById('diaryTitle').setAttribute('dir', 'rtl');
        document.getElementById('diaryText').setAttribute('dir', 'rtl');
      } else {
        document.getElementById('diaryTitle').setAttribute('dir', 'ltr');
        document.getElementById('diaryText').setAttribute('dir', 'ltr');
      }
    }

    /* دوال الآلة الحاسبة الاحترافية */
    let currentInput = "";
    const display = document.getElementById('display');
    let memory = 0;
    function clearInput() {
      currentInput = "";
      display.value = currentInput;
    }
    function backspace() {
      currentInput = currentInput.slice(0, -1);
      display.value = currentInput;
    }
    function appendDigit(digit) {
      currentInput += digit;
      display.value = currentInput;
    }
    function appendOperator(op) {
      if (currentInput === "") {
        if (op === "-") {
          currentInput = op;
          display.value = currentInput;
        }
        return;
      }
      let lastChar = currentInput.slice(-1);
      if (["+", "-", "×", "÷"].includes(lastChar)) {
        currentInput = currentInput.slice(0, -1) + op;
      } else {
        currentInput += op;
      }
      display.value = currentInput;
    }
    function calculateResult() {
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      let calcPass = "12345678";
      if (currentAccount && currentAccount.calcPassword) {
        calcPass = decrypt(currentAccount.calcPassword);
      }
      if (currentInput === calcPass) {
        document.querySelector('.calculator-container').style.display = 'none';
        document.querySelector('.diary-container').style.display = 'flex';
        currentInput = "";
        display.value = "";
        loadDiaryEntries();
        return;
      }
      try {
        let expression = currentInput.replace(/×/g, '*').replace(/÷/g, '/');
        let result = eval(expression);
        display.value = result;
        currentInput = result.toString();
      } catch (error) {
        display.value = translations[currentLang].calcError;
        currentInput = "";
      }
    }
    function toggleSign() {
      if (currentInput) {
        if (currentInput.charAt(0) === "-") {
          currentInput = currentInput.slice(1);
        } else {
          currentInput = "-" + currentInput;
        }
        display.value = currentInput;
      }
    }
    function applySqrt() {
      try {
        let value = parseFloat(currentInput);
        if (value < 0) {
          display.value = translations[currentLang].calcError;
          currentInput = "";
          return;
        }
        let result = Math.sqrt(value);
        currentInput = result.toString();
        display.value = currentInput;
      } catch (error) {
        display.value = translations[currentLang].calcError;
        currentInput = "";
      }
    }
    function memoryClear() {
      memory = 0;
    }
    function memoryRecall() {
      currentInput += memory.toString();
      display.value = currentInput;
    }
    function memoryAdd() {
      try {
        let value = parseFloat(currentInput);
        memory += value;
      } catch (error) {}
    }
    function memorySubtract() {
      try {
        let value = parseFloat(currentInput);
        memory -= value;
      } catch (error) {}
    }

    /* دوال إدارة الحساب */
    let originalAccount = null;
    function openAccountPanel() {
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (currentAccount) {
        originalAccount = JSON.parse(JSON.stringify(currentAccount));
        updateAccountInfoModalFromOriginal();
        document.getElementById('accountInfoModal').style.display = 'flex';
      } else {
        document.getElementById('accountActionsModal').style.display = 'flex';
      }
    }
    function updateAccountInfoModalFromOriginal() {
      document.getElementById('accountNameInput').value = decrypt(originalAccount.name);
      document.getElementById('accountProfileImage').src = (originalAccount.image && originalAccount.image.trim() !== "")
        ? originalAccount.image
        : "https://cdn-icons-png.flaticon.com/512/847/847969.png";
    }
    function createAccount() {
      const email = document.getElementById('accountEmail').value.trim();
      const password = document.getElementById('accountPassword').value.trim();
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showMessage(translations[currentLang].accountCreatedMsg, 2000);
        return;
      }
      if (email !== email.toLowerCase()) {
        showMessage(translations[currentLang].emailLowercaseOnly, 2000);
        return;
      }
      if (email === "" || password === "") {
        showMessage("الرجاء إدخال البريد الإلكتروني وكلمة المرور", 2000);
        return;
      }
      if (password.length < 8) {
        showMessage("يجب أن تكون كلمة المرور 8 أرقام على الأقل", 2000);
        return;
      }
      if (!/^\d+$/.test(password)) {
        showMessage("يجب أن تتكون كلمة المرور من أرقام فقط", 2000);
        return;
      }
      let accounts = JSON.parse(localStorage.getItem('accounts')) || [];
      if (accounts.find(acc => decrypt(acc.email) === email)) {
        showMessage("البريد الإلكتروني مستخدم بالفعل", 2000);
        return;
      }
      const account = {
        email: encrypt(email),
        password: encrypt(password),
        calcPassword: encrypt("12345678"),
        name: encrypt(""),
        image: ""
      };
      accounts.push(account);
      localStorage.setItem('accounts', JSON.stringify(accounts));
      localStorage.setItem('currentAccount', JSON.stringify(account));
      closeAccountCreationModal();
      closeAccountActionsModal();
      showMessage(translations[currentLang].accountCreatedMsg, 2000);
      loadDiaryEntries();
    }
    function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      let accounts = JSON.parse(localStorage.getItem('accounts')) || [];
      const account = accounts.find(acc => decrypt(acc.email) === email && decrypt(acc.password) === password);
      if (account) {
        localStorage.setItem('currentAccount', JSON.stringify(account));
        closeLoginModal();
        closeAccountActionsModal();
        showMessage(translations[currentLang].loginSuccessMsg, 2000);
        loadDiaryEntries();
      } else {
        showMessage(translations[currentLang].loginFailedMsg, 2000);
      }
    }
    function logout() {
      localStorage.removeItem('currentAccount');
      showMessage(translations[currentLang].logoutYesBtn, 2000);
      closeAccountInfoModal();
      loadDiaryEntries();
    }
    function saveAccountChanges(account) {
      let accounts = JSON.parse(localStorage.getItem('accounts')) || [];
      accounts = accounts.map(acc => decrypt(acc.email) === decrypt(account.email) ? account : acc);
      localStorage.setItem('accounts', JSON.stringify(accounts));
      localStorage.setItem('currentAccount', JSON.stringify(account));
    }
    function saveAccountInfoChanges() {
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (currentAccount) {
        const newName = document.getElementById('accountNameInput').value.trim();
        const newImageRaw = document.getElementById('accountProfileImage').src;
        const defaultImage = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        const newImage = (newImageRaw === defaultImage) ? "" : newImageRaw;
        currentAccount.name = encrypt(newName);
        currentAccount.image = newImage;
        saveAccountChanges(currentAccount);
        updateAccountInfoModal();
        showMessage(translations[currentLang].changesSavedMsg, 2000);
      }
    }
    function updateAccountInfoModal() {
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (currentAccount) {
        document.getElementById('accountNameInput').value = decrypt(currentAccount.name);
        document.getElementById('accountProfileImage').src = (currentAccount.image && currentAccount.image.trim() !== "")
          ? currentAccount.image
          : "https://cdn-icons-png.flaticon.com/512/847/847969.png";
      }
      updateDiaryCount();
    }
    function changeProfileImage(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('accountProfileImage').src = e.target.result;
          showMessage(translations[currentLang].imageChangedMsg, 2000);
        }
        reader.readAsDataURL(file);
      }
    }
    function toggleImageOptions() {
      var options = document.getElementById('imageOptions');
      options.style.display = options.style.display === "flex" ? "none" : "flex";
    }
    function triggerChangeImage() {
      document.getElementById('accountImageInput').click();
      document.getElementById('imageOptions').style.display = "none";
    }
    function deleteProfileImage() {
      const currentSrc = document.getElementById('accountProfileImage').src;
      const defaultImage = "https://cdn-icons-png.flaticon.com/512/847/847969.png";
      if (currentSrc === defaultImage) {
        showMessage("لا توجد صورة لحذفها", 2000);
      } else {
        document.getElementById('accountProfileImage').src = defaultImage;
        showMessage(translations[currentLang].imageDeletedMsg, 2000);
      }
      document.getElementById('imageOptions').style.display = "none";
    }
    document.getElementById('imageOptions').addEventListener('click', function(e) {
      if (e.target === this) {
        this.style.display = "none";
      }
    });

    /* دوال إدارة اليوميات */
    let diaryEntries = [];
    let currentDiaryIndex = null;
    function loadDiaryEntries() {
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (currentAccount) {
        diaryEntries = JSON.parse(localStorage.getItem('diaryEntries_' + decrypt(currentAccount.email))) || [];
      } else {
        diaryEntries = JSON.parse(localStorage.getItem('diaryEntries_global')) || [];
      }
      updateDiaryCount();
    }
    function saveDiary() {
      const title = document.getElementById('diaryTitle').value.trim();
      const text = document.getElementById('diaryText').value;
      if (text.trim() !== "") {
        const now = new Date();
        // تعيين locale إلى en-US دائماً لضمان ظهور الأرقام الإنجليزية
        const locale = 'en-US';
        const dateTime = now.toLocaleDateString(locale) + translations[currentLang].dateTimeSeparator + now.toLocaleTimeString(locale);
        diaryEntries.push({ dateTime, title, text });
        let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
        if (currentAccount) {
          localStorage.setItem('diaryEntries_' + decrypt(currentAccount.email), JSON.stringify(diaryEntries));
        } else {
          localStorage.setItem('diaryEntries_global', JSON.stringify(diaryEntries));
        }
        document.getElementById('diaryTitle').value = "";
        document.getElementById('diaryText').value = "";
        updateDiaryCount();
        // تعديل: عرض رسالة "تم الحفظ" بدلاً من "تم إنشاء الحساب"
        showMessage(translations[currentLang].diarySavedMsg, 2000);
      }
    }
    function updateDiaryCount() {
      let countText = translations[currentLang].accountInfoAccountCount;
      let count = diaryEntries.length;
      document.getElementById('diaryCountText').innerText = countText + count;
    }
    function renderDiaryGrid(entries) {
      const grid = document.getElementById('diaryGrid');
      grid.innerHTML = "";
      entries.forEach(entry => {
        const originalIndex = diaryEntries.indexOf(entry);
        const card = document.createElement('div');
        card.className = "diary-card";
        card.setAttribute("data-index", originalIndex);
        const datetimeDiv = document.createElement('div');
        datetimeDiv.className = "diary-datetime";
        datetimeDiv.innerText = entry.dateTime;
        card.appendChild(datetimeDiv);
        const hr = document.createElement('hr');
        card.appendChild(hr);
        const titleDiv = document.createElement('div');
        titleDiv.className = "diary-title";
        titleDiv.innerText = (entry.title && entry.title.trim() !== "") ? entry.title : (currentLang === 'ar' ? "بدون عنوان" : "Untitled");
        card.appendChild(titleDiv);
        card.onclick = function() {
          openDiaryModal(originalIndex);
        };
        grid.appendChild(card);
      });
    }
    function showDiaryGridView() {
      document.getElementById('diaryInputForm').style.display = 'none';
      document.getElementById('diaryGridView').style.display = 'flex';
      renderDiaryGrid(diaryEntries);
    }
    function backToDiaryInput() {
      document.getElementById('diaryGridView').style.display = 'none';
      document.getElementById('diaryInputForm').style.display = 'flex';
    }
    function goBack() {
      document.querySelector('.diary-container').style.display = 'none';
      document.querySelector('.calculator-container').style.display = 'flex';
    }
    let searchTimeout;
    function searchDiary() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = document.getElementById('diarySearchInput').value.trim().toLowerCase();
        if(query === "") {
          renderDiaryGrid(diaryEntries);
          return;
        }
        const filtered = diaryEntries.filter(entry =>
          (entry.title && entry.title.toLowerCase().includes(query)) ||
          (entry.text && entry.text.toLowerCase().includes(query)) ||
          (entry.dateTime && entry.dateTime.toLowerCase().includes(query))
        );
        renderDiaryGrid(filtered);
      }, 300);
    }
    function openDiaryModal(index) {
      currentDiaryIndex = index;
      const entry = diaryEntries[index];
      document.getElementById('modalTitle').innerText = (entry.title && entry.title.trim() !== "") ? entry.title : (currentLang === 'ar' ? "بدون عنوان" : "Untitled");
      document.getElementById('modalText').innerText = entry.text;
      document.getElementById('diaryModal').style.display = 'flex';
    }
    function closeDiaryModal() {
      document.getElementById('diaryModal').style.display = 'none';
    }
    function deleteDiaryEntry() {
      document.getElementById('deleteConfirmModal').style.display = 'flex';
    }
    function closeDeleteConfirmModal() {
      document.getElementById('deleteConfirmModal').style.display = 'none';
    }
    function promptDeletePassword() {
      document.getElementById('deleteConfirmModal').style.display = 'none';
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (!currentAccount) {
        diaryEntries.splice(currentDiaryIndex, 1);
        localStorage.setItem('diaryEntries_global', JSON.stringify(diaryEntries));
        closeDiaryModal();
        renderDiaryGrid(diaryEntries);
        showMessage(translations[currentLang].deletionSuccessMsg, 2000);
      } else {
        document.getElementById('deletePasswordModal').style.display = 'flex';
      }
    }
    function confirmDeleteWithPassword() {
      const password = document.getElementById('deletePasswordInput').value.trim();
      const currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (currentAccount && decrypt(currentAccount.password) !== password) {
        showMessage("كلمة السر غير صحيحة", 2000);
        return;
      }
      diaryEntries.splice(currentDiaryIndex, 1);
      if (currentAccount) {
        localStorage.setItem('diaryEntries_' + decrypt(currentAccount.email), JSON.stringify(diaryEntries));
      } else {
        localStorage.setItem('diaryEntries_global', JSON.stringify(diaryEntries));
      }
      document.getElementById('deletePasswordInput').value = "";
      closeDeletePasswordModal();
      closeDiaryModal();
      renderDiaryGrid(diaryEntries);
      showMessage(translations[currentLang].deletionSuccessMsg, 2000);
    }
    function closeDeletePasswordModal() {
      document.getElementById('deletePasswordModal').style.display = 'none';
    }
    function showMessage(text, duration = 2000) {
      const messageBox = document.getElementById('messageBox');
      messageBox.innerText = text;
      messageBox.style.display = 'block';
      setTimeout(() => {
        messageBox.style.display = 'none';
      }, duration);
    }

    /* النوافذ المنبثقة */
    function closeAccountActionsModal() {
      document.getElementById('accountActionsModal').style.display = 'none';
    }
    function openAccountCreationModal() {
      document.getElementById('accountCreationModal').style.display = 'flex';
    }
    function closeAccountCreationModal() {
      document.getElementById('accountCreationModal').style.display = 'none';
    }
    function openLoginModal() {
      document.getElementById('loginEmail').value = "";
      document.getElementById('loginPassword').value = "";
      document.getElementById('loginModal').style.display = 'flex';
    }
    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
    }
    function closeAccountInfoModal() {
      document.getElementById('accountInfoModal').style.display = 'none';
    }
    let selectedPasswordOption = null;
    function openChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'flex';
      document.getElementById('changePasswordFields').style.display = 'none';
      selectedPasswordOption = null;
      document.getElementById('oldPasswordInput').value = "";
      document.getElementById('newPasswordInput').value = "";
      document.getElementById('confirmNewPasswordInput').value = "";
    }
    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'none';
    }
    function selectPasswordOption(option) {
      selectedPasswordOption = option;
      document.getElementById('changePasswordFields').style.display = 'block';
      document.getElementById('oldPasswordInput').placeholder = option === 'account'
        ? translations[currentLang].oldPasswordPlaceholderAccount
        : translations[currentLang].oldPasswordPlaceholderCalc;
    }
    function submitChangePassword() {
      let oldPass = document.getElementById('oldPasswordInput').value.trim();
      let newPass = document.getElementById('newPasswordInput').value.trim();
      let confirmPass = document.getElementById('confirmNewPasswordInput').value.trim();
      if (newPass.length < 8) {
        showMessage("يجب أن تكون كلمة السر الجديدة 8 أرقام على الأقل", 2000);
        return;
      }
      if (!/^\d+$/.test(newPass)) {
        showMessage("يجب أن تتكون كلمة السر من أرقام فقط", 2000);
        return;
      }
      let currentAccount = JSON.parse(localStorage.getItem('currentAccount'));
      if (!currentAccount) {
        showMessage(translations[currentLang].noAccountMsg, 2000);
        return;
      }
      if (selectedPasswordOption === 'account') {
        if (decrypt(currentAccount.password) !== oldPass) {
          showMessage("كلمة السر الحالية غير صحيحة", 2000);
          return;
        }
        if (newPass !== confirmPass) {
          showMessage("كلمة السر الجديدة وتأكيدها غير متطابقين", 2000);
          return;
        }
        currentAccount.password = encrypt(newPass);
      } else if (selectedPasswordOption === 'calc') {
        const currentCalcPass = decrypt(currentAccount.calcPassword) || "12345678";
        if (oldPass !== currentCalcPass) {
          showMessage("كلمة السر الحالية غير صحيحة", 2000);
          return;
        }
        if (newPass !== confirmPass) {
          showMessage("كلمة السر الجديدة وتأكيدها غير متطابقين", 2000);
          return;
        }
        currentAccount.calcPassword = encrypt(newPass);
      } else {
        showMessage("اختر نوع كلمة السر للتغيير", 2000);
        return;
      }
      saveAccountChanges(currentAccount);
      closeChangePasswordModal();
      showMessage(translations[currentLang].passwordChangedMsg, 2000);
    }
    function openForgotPasswordModal() {
      showMessage(translations[currentLang].optionNotWorking, 2000);
    }
    function closeForgotPasswordModal() {
      document.getElementById('forgotPasswordModal').style.display = 'none';
    }
    function sendForgotPasswordCode() {
      showMessage(translations[currentLang].optionNotWorking, 2000);
    }
    function openLogoutConfirmModal() {
      document.getElementById('logoutConfirmModal').style.display = 'flex';
    }
    function closeLogoutConfirmModal() {
      document.getElementById('logoutConfirmModal').style.display = 'none';
    }
    function confirmLogout() {
      logout();
      closeLogoutConfirmModal();
      showMessage(translations[currentLang].logoutYesBtn, 2000);
    }
    function toggleDiaryMode() {
      var diaryContainer = document.querySelector('.diary-container');
      diaryContainer.classList.toggle("diary-dark-mode");
      var modalIds = ["diaryModal", "accountActionsModal", "accountCreationModal", "loginModal", "accountInfoModal", "changePasswordModal", "forgotPasswordModal", "logoutConfirmModal", "deleteConfirmModal", "deletePasswordModal"];
      modalIds.forEach(function(id) {
        var modal = document.getElementById(id);
        if (modal) { modal.classList.toggle("diary-dark-mode"); }
      });
      var btn = document.getElementById("diaryModeToggle");
      btn.innerText = diaryContainer.classList.contains("diary-dark-mode") ? "☀️" : "🌙";
    }

    /* تغيير اللغة وتحديث اتجاه الصفحة */
    var currentLang = 'ar';
    function toggleLangDropdown() {
      let dropdown = document.getElementById('langDropdown');
      dropdown.style.display = (dropdown.style.display === 'block') ? 'none' : 'block';
    }
    function setLanguage(lang) {
      currentLang = lang;
      // تحديث اتجاه الصفحة واللغة في المستند
      document.documentElement.setAttribute("dir", lang === "en" ? "ltr" : "rtl");
      document.documentElement.setAttribute("lang", lang);
      applyTranslations();
      document.getElementById('langDropdown').style.display = 'none';
    }
    document.addEventListener('click', function(event) {
      let dropdown = document.getElementById('langDropdown');
      let langIcon = document.getElementById('langIcon');
      if (!dropdown.contains(event.target) && !langIcon.contains(event.target)) {
        dropdown.style.display = 'none';
      }
    });

    // التطبيق الأولي للترجمات
    applyTranslations();
  </script>
</body>
</html>
